// Case1 - Email : Malware, threatname list detected by Exchange Online Protection and Microsfot Defender for Office 365
// Case2 - Device : Malware, threatname list detected by Microsoft Defender Antivirus 

EmailEvents
| where Timestamp > ago(30d)
| where isnotempty(ThreatNames)
| extend ThreatName = split(ThreatNames, ",")
| mv-expand ThreatName
| summarize ThreatNumber = count() by tostring(ThreatName)
| sort by ThreatNumber desc 

DeviceEvents
| where ActionType == "AntivirusDetection"
| extend DetectionType =parse_json(AdditionalFields)
| project Timestamp, DeviceId, DeviceName, ActionType, DetectionType.ReportSource, DetectionType.ThreatName
| summarize ThreatNumber= count() by tostring(DetectionType_ThreatName)
| sort by ThreatNumber desc 
